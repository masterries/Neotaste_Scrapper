<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vienna Restaurant Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        #map { height: 400px; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8">Vienna Restaurant Explorer</h1>

        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4">Filters</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <select id="priceFilter" class="border rounded p-2">
                    <option value="">All Price Ranges</option>
                    <option value="1">$</option>
                    <option value="2">$$</option>
                    <option value="3">$$$</option>
                    <option value="4">$$$$</option>
                </select>
                <input type="text" id="zipCodeFilter" placeholder="Enter ZIP code" class="border rounded p-2">
                <select id="tagFilter" class="border rounded p-2">
                    <option value="">All Tags</option>
                </select>
            </div>
        </div>

        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4">Restaurant Map</h2>
            <div id="map"></div>
        </div>

        <div>
            <h2 class="text-2xl font-semibold mb-4">Restaurant Deals</h2>
            <div id="restaurantCards" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            </div>
        </div>
    </div>

    <script>
        let restaurants = [];
        let map;
        let markers = [];

        async function fetchData() {
            try {
                const response = await fetch('./data/latest_full_data.json');
                restaurants = await response.json();
                initMap();
                populateTagFilter();
                filterRestaurants();
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        function initMap() {
            map = L.map('map').setView([48.2082, 16.3738], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        function populateTagFilter() {
            const tagFilter = document.getElementById('tagFilter');
            const allTags = [...new Set(restaurants.flatMap(r => r.tags.map(t => t.name)))];
            allTags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = tag;
                tagFilter.appendChild(option);
            });
        }

        function filterRestaurants() {
            const priceFilter = document.getElementById('priceFilter').value;
            const zipCodeFilter = document.getElementById('zipCodeFilter').value;
            const tagFilter = document.getElementById('tagFilter').value;

            let filteredRestaurants = restaurants;

            if (priceFilter) {
                filteredRestaurants = filteredRestaurants.filter(r => r.priceRange === parseInt(priceFilter));
            }

            if (zipCodeFilter) {
                filteredRestaurants = filteredRestaurants.filter(r => r.zipCode.startsWith(zipCodeFilter));
            }

            if (tagFilter) {
                filteredRestaurants = filteredRestaurants.filter(r => r.tags.some(t => t.name === tagFilter));
            }

            updateMap(filteredRestaurants);
            updateRestaurantCards(filteredRestaurants);
        }

        function updateMap(filteredRestaurants) {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            filteredRestaurants.forEach(restaurant => {
                const marker = L.marker([restaurant.latitude, restaurant.longitude]).addTo(map);
                marker.bindPopup(`
                    <b>${restaurant.name}</b><br>
                    ${restaurant.address}<br>
                    Rating: ${restaurant.avgRating.toFixed(1)} (${restaurant.ratingsCount} ratings)<br>
                    ${restaurant.deals.length > 0 ? `Top deal: ${restaurant.deals[0].name}` : 'No deals available'}
                `);
                markers.push(marker);
            });
        }

        function updateRestaurantCards(filteredRestaurants) {
        const restaurantCards = document.getElementById('restaurantCards');
        restaurantCards.innerHTML = '';

        filteredRestaurants
            .filter(r => r.deals.length > 0)
            .sort((a, b) => Math.max(...b.deals.map(d => d.value)) - Math.max(...a.deals.map(d => d.value)))
            .forEach(restaurant => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md overflow-hidden mb-6';
                card.innerHTML = `
                    <div class="p-4">
                        <div class="flex items-center justify-between mb-2">
                            <h2 class="text-xl font-semibold">${restaurant.name}</h2>
                            <span class="text-sm font-medium bg-blue-100 text-blue-800 py-1 px-2 rounded">${'$'.repeat(restaurant.priceRange)}</span>
                        </div>
                        <div class="flex items-center mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                            </svg>
                            <span>${restaurant.avgRating.toFixed(1)} (${restaurant.ratingsCount} ratings)</span>
                        </div>
                        <div class="flex items-center mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                            </svg>
                            <span>${restaurant.address}, ${restaurant.zipCode}</span>
                        </div>
                        <h3 class="font-semibold text-lg mb-2">Deals:</h3>
                        ${restaurant.deals.map(deal => `
                            <a href="https://neotaste.app/invite/Patrick3632" target="_blank" class="block bg-yellow-50 p-3 rounded mb-3 hover:bg-yellow-100 transition duration-300">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="font-medium text-lg">${deal.name}</h4>
                                    <span class="font-bold text-green-600">Value: ‚Ç¨${deal.value}</span>
                                </div>
                                <p class="text-sm text-gray-600 mb-2">${formatConditions(deal.conditions)}</p>
                                <div class="flex justify-between text-xs text-gray-500">
                                    <span>Location: ${deal.locationCondition}</span>
                                    <span>Reset: ${deal.daysToReset} days</span>
                                    <span class="capitalize">${deal.status}</span>
                                </div>
                            </a>
                        `).join('')}
                    </div>
                `;
                restaurantCards.appendChild(card);
            });
    }

        function formatConditions(conditions) {
            return conditions
                .replace(/üçú/g, '<span class="text-xl">üçú</span>')
                .replace(/‚Ç¨(\d+)/g, '<span class="font-semibold text-green-600">‚Ç¨$1</span>')
                .split('. ')
                .map(sentence => `<p class="mb-1">${sentence}${sentence.endsWith('.') ? '' : '.'}</p>`)
                .join('');
        }

        document.getElementById('priceFilter').addEventListener('change', filterRestaurants);
        document.getElementById('zipCodeFilter').addEventListener('input', filterRestaurants);
        document.getElementById('tagFilter').addEventListener('change', filterRestaurants);

        fetchData();
    </script>
</body>
</html>